&GLOBAL
  ECHO_INPUT
  PRINT_LEVEL LOW
  PROJECT REACT-NVT-EE-GPW
  RUN_TYPE MD
  SAVE_MEM TRUE
&END GLOBAL

&FORCE_EVAL
  METHOD QMMM
  STRESS_TENSOR ANALYTICAL
  &DFT
    CHARGE -1
    MULTIPLICITY 1
!    BASIS_SET_FILE_NAME GTH_BASIS_SETS
!    POTENTIAL_FILE_NAME GTH_POTENTIALS
    &MGRID
      COMMENSURATE  #mandatory to use GEEP
      CUTOFF 300
    &END MGRID
    &QS
      METHOD GPW
    &END QS

    &SCF
      EPS_SCF 1E-6
      MAX_SCF 30
      SCF_GUESS ATOMIC
      &OT
        MINIMIZER DIIS
        PRECONDITIONER FULL_SINGLE_INVERSE
        SAFE_DIIS TRUE
      &END OT
      &OUTER_SCF
        EPS_SCF 1E-6
        MAX_SCF 10
      &END OUTER_SCF
    &END SCF
    &XC
      &XC_FUNCTIONAL PBE
      &END XC_FUNCTIONAL
    &END XC
  &END DFT
  &MM
    &FORCEFIELD
!     EI_SCALE14 0.8333
!     VDW_SCALE14 0.5000
      PARMTYPE AMBER
      PARM_FILE_NAME complex_LJ_mod_neutral89QM.prmtop
      &SPLINE
        EMAX_SPLINE 1.0E8
        RCUT_NB [angstrom] 10
      &END SPLINE
    &END FORCEFIELD
    &POISSON
      &EWALD
        EWALD_TYPE SPME
        ALPHA .40
        GMAX 80
      &END EWALD
    &END POISSON
  &END MM
  &QMMM
    ECOUPL GAUSS
    USE_GEEP_LIB 6
    &CELL
      ABC 20 20 20
      ALPHA_BETA_GAMMA 90 90 90
    &END CELL
    &QM_KIND  O
      MM_INDEX  5668
      MM_INDEX  5669
      MM_INDEX  5670
      MM_INDEX  5682
      MM_INDEX  5685
      MM_INDEX  5686
    &END QM_KIND
    &QM_KIND  H
      MM_INDEX  1414
      MM_INDEX  1415
      MM_INDEX  1417
      MM_INDEX  1418
      MM_INDEX  1420
      MM_INDEX  1421
      MM_INDEX  1423
      MM_INDEX  1426
      MM_INDEX  1427
      MM_INDEX  1429
      MM_INDEX  1430
      MM_INDEX  5664
      MM_INDEX  5665
      MM_INDEX  5672
      MM_INDEX  5674
      MM_INDEX  5677
      MM_INDEX  5679
      MM_INDEX  5681
      MM_INDEX  5683
    &END QM_KIND
    &QM_KIND  C
      MM_INDEX  1413
      MM_INDEX  1416
      MM_INDEX  1419
      MM_INDEX  1424
      MM_INDEX  5663
      MM_INDEX  5666
      MM_INDEX  5667
      MM_INDEX  5671
      MM_INDEX  5673
      MM_INDEX  5675
      MM_INDEX  5676
      MM_INDEX  5678
      MM_INDEX  5680
      MM_INDEX  5684
    &END QM_KIND
    &QM_KIND  N
      MM_INDEX  1422
      MM_INDEX  1425
      MM_INDEX  1428
    &END QM_KIND
    &LINK
      MM_INDEX  1411
      QM_INDEX  1413
      LINK_TYPE IMOMM
    &END LINK
  &END QMMM
  &SUBSYS
    &CELL
      ABC [angstrom] 79.006   79.682   79.030
      ALPHA_BETA_GAMMA 90 90 90
    &END CELL
    &TOPOLOGY
      CONN_FILE_FORMAT AMBER
      CONN_FILE_NAME complex_LJ_mod_neutral89QM.prmtop
      COORDINATE XYZ
      COORD_FILE_NAME ./geom.xyz
    &END TOPOLOGY

   &VELOCITY
       @INCLUDE "vel.xyz"
    &END VELOCITY

    &KIND NA+
     ELEMENT Na
    &END KIND
    &KIND C
      BASIS_SET DZVP-GTH-PBE
      POTENTIAL GTH-PBE-q4
    &END KIND
   &KIND N
      BASIS_SET DZVP-GTH-PBE
      POTENTIAL GTH-PBE-q5
    &END KIND
    &KIND O
      BASIS_SET DZVP-GTH-PBE
      POTENTIAL GTH-PBE-q6
    &END KIND
    &KIND H
      BASIS_SET DZVP-GTH-PBE
      POTENTIAL GTH-PBE-q1
    &END KIND
  &END SUBSYS
&END FORCE_EVAL


&MOTION
  &MD
    &THERMOSTAT
      &CSVR
        TIMECON 100
      &END CSVR
      &DEFINE_REGION
        MM_SUBSYS ATOMIC
        QM_SUBSYS ATOMIC
      &END DEFINE_REGION
      TYPE CSVR 
    &END THERMOSTAT
    ENSEMBLE NVT
    STEPS 100000
    MAX_STEPS 2000000
    TEMPERATURE 300.0
    TIMESTEP 1.0
  &END MD

  &PRINT
    &RESTART                                    ! This section controls the printing of restart files
      &EACH
        MD 1000
      &END EACH
      ADD_LAST NUMERIC
      SPLIT_RESTART_FILE TRUE
    &END RESTART
    &RESTART_HISTORY
      &EACH
        MD 5000
      &END EACH
      ADD_LAST NUMERIC
    &END RESTART_HISTORY
    &TRAJECTORY                                 ! Controls the output of the trajectory
      &EACH                                     ! New trajectory frame will be printed each 100 md steps
        MD 20
      &END EACH
      ADD_LAST NUMERIC                          ! Last trajectory frame printed at the end of the calculation
      FORMAT XYZ                                ! Format of the output trajectory is XYZ
    &END TRAJECTORY
  &END PRINT

 &FREE_ENERGY
    &METADYN
      USE_PLUMED .TRUE.
      PLUMED_INPUT_FILE ./plumed.dat
    &END METADYN
  &END FREE_ENERGY

&END MOTION

!&EXT_RESTART
!  RESTART_FILE_NAME REACT-NVT-EE-PM6-1.restart
!  BINARY_RESTART_FILE_NAME REACT-NVT-EE-PM6-1.restart.bin
!  RESTART_COUNTERS .FALSE.
!!  RESTART_THERMOSTAT .FALSE.
!&END
